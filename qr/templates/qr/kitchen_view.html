{% extends 'qr/base.html' %}

{% block title %}注文状況 - QR注文システム{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-kitchen-set me-2"></i>厨房画面</h2>
        <button class="btn btn-secondary" onclick="location.reload()">
            <i class="fas fa-sync-alt me-1"></i>更新
        </button>
    </div>
</div>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="row">
    <div class="col-12">
       <table class="table table-bordered table-striped align-middle"
       style="--bs-table-striped-bg: #fff2cc;">
        <colgroup>
            <col style="width: 10%;">
            <col style="width: 10%;">
            <col style="width: 10%;">
            <col style="width: 20%;">
            <col style="width: 15%;">
            <col style="width: 35%;">
        </colgroup>
        <thead class="table-primary">
            <tr style="color: black;">
                <th style="background-color:#f6b26b;">注文ID</th>
                <th style="background-color:#f6b26b;">注文時間</th>
                <th style="background-color:#f6b26b;">テーブル番号</th>
                <th style="background-color:#f6b26b;">注文内容</th>
                <th style="background-color:#f6b26b;">注文金額合計</th>
                <th style="background-color:#f6b26b;">ステータス変更</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
                {% if order.status != 'delivered' and order.status != 'cancelled' %}
                <tr>
                    <td>注文 #{{ order.id }}</td>
                    <td>{{ order.created_at|date:"n月j日 H:i" }}</td>
                    <td>{{ order.table.table_number }}</td>
                    <td>
                        {% for item in order.items.all %}
                            {{ item.menu_item.name }} × {{ item.quantity }}<br>
                            {% if item.notes %}
                                <small class="text-muted">備考: {{ item.notes }}</small><br>
                            {% endif %}
                        {% endfor %}
                        {% if order.notes %}
                            <div><strong>全体備考:</strong> {{ order.notes }}</div>
                        {% endif %}
                    </td>
                    <td>¥{{ order.total_amount|floatformat:0 }}</td>
                    <td>
                        <div class="btn-group" role="group">
                            {% for value, label in order.ORDER_STATUS_CHOICES %}
                                <button 
                                    type="button" 
                                    class="btn btn-sm status-btn {% if order.status == value %}btn-primary{% else %}btn-outline-primary{% endif %}"
                                    data-order-id="{{ order.id }}"
                                    data-status="{{ value }}">
                                    {{ label }}
                                </button>
                            {% endfor %}
                        </div>
                    </td>
                </tr>
                {% endif %}
            {% empty %}
            <tr><td colspan="6" class="text-center text-muted">現在処理中の注文はありません</td></tr>
            {% endfor %}
        </tbody>
    </table>
<br>
    <h5 class="mb-0 mt-8">完了・キャンセル済みの注文</h5>
    <table class="table table-bordered table-striped align-middle mt-0"">
        <colgroup>
            <col style="width: 10%;">
            <col style="width: 10%;">
            <col style="width: 10%;">
            <col style="width: 20%;">
            <col style="width: 15%;">
            <col style="width: 35%;">
        </colgroup>
        <thead class="table-dark">
            <tr style="color: black;">
                <th>注文ID</th>
                <th>注文時間</th>
                <th>テーブル番号</th>
                <th>注文内容</th>
                <th>注文金額合計</th>
                <th>ステータス</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
                {% if order.status == 'delivered' or order.status == 'cancelled' %}
                <tr class="table-secondary">
                    <td>注文 #{{ order.id }}</td>
                    <td>{{ order.created_at|date:"n月j日 H:i" }}</td>
                    <td>{{ order.table.table_number }}</td>
                    <td>
                        {% for item in order.items.all %}
                            {{ item.menu_item.name }} × {{ item.quantity }}<br>
                        {% endfor %}
                    </td>
                    <td>¥{{ order.total_amount|floatformat:0 }}</td>
                    <td>
                        <span class="btn btn-sm btn-secondary disabled">{{ order.get_status_display }}</span>
                        <button 
                            type="button" 
                            class="btn btn-sm btn-warning retry-btn"
                            data-order-id="{{ order.id }}"
                            data-status="preparing">やり直す</button>
                    </td>

                </tr>
                {% endif %}
            {% empty %}
            <tr>
                <td colspan="6" class="text-center text-muted">完了した注文はまだありません</td></tr>
            {% endfor %}
            </tbody>
        </table>



    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // ステータス変更
    $('.status-select').change(function() {
        const orderId = $(this).data('order-id');
        const newStatus = $(this).val();
        const selectElement = $(this);
        
        $.ajax({
            url: `/update-order-status/${orderId}/`,
            type: 'POST',
            data: {
                'status': newStatus,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    location.reload();
                } else {
                    alert('ステータスの更新に失敗しました。');
                    selectElement.prop('selectedIndex', 0);
                }
            },
            error: function() {
                alert('ステータスの更新に失敗しました。');
                selectElement.prop('selectedIndex', 0);
            }
        });
    });
    
    // 自動更新（30秒ごと）
    setInterval(function() {
        location.reload();
    }, 30000);
});


// やり直すボタン
$('.retry-btn').click(function() {
    const orderId = $(this).data('order-id');
    const resetStatus = $(this).data('status');  // 例: "preparing"

    if (!confirm('この注文を処理中に戻しますか？')) {
        return;
    }

    $.ajax({
        url: `/update-order-status/${orderId}/`,
        type: 'POST',
        data: {
            'status': resetStatus,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.status === 'success') {
                location.reload();
            } else {
                alert('ステータスの更新に失敗しました。');
            }
        },
        error: function() {
            alert('ステータスの更新に失敗しました。');
        }
    });
});



$(document).ready(function() {
    // ステータス変更（ボタン版）
    $('.status-btn').click(function() {
        const orderId = $(this).data('order-id');
        const newStatus = $(this).data('status');
        const buttonElement = $(this);

        $.ajax({
            url: `/update-order-status/${orderId}/`,
            type: 'POST',
            data: {
                'status': newStatus,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    location.reload();  // 状態更新後にリロード
                } else {
                    alert('ステータスの更新に失敗しました。');
                }
            },
            error: function() {
                alert('ステータスの更新に失敗しました。');
            }
        });
    });

    // 自動更新（30秒ごと）
    setInterval(function() {
        location.reload();
    }, 30000);
});
</script>
{% endblock %}
